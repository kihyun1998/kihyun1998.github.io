"use strict";(self.webpackChunkblogsaurus=self.webpackChunkblogsaurus||[]).push([[5800],{3905:(e,r,n)=>{n.d(r,{Zo:()=>i,kt:()=>k});var t=n(67294);function a(e,r,n){return r in e?Object.defineProperty(e,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[r]=n,e}function s(e,r){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);r&&(t=t.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,t)}return n}function u(e){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?s(Object(n),!0).forEach((function(r){a(e,r,n[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))}))}return e}function o(e,r){if(null==e)return{};var n,t,a=function(e,r){if(null==e)return{};var n,t,a={},s=Object.keys(e);for(t=0;t<s.length;t++)n=s[t],r.indexOf(n)>=0||(a[n]=e[n]);return a}(e,r);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(t=0;t<s.length;t++)n=s[t],r.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=t.createContext({}),c=function(e){var r=t.useContext(l),n=r;return e&&(n="function"==typeof e?e(r):u(u({},r),e)),n},i=function(e){var r=c(e.components);return t.createElement(l.Provider,{value:r},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var r=e.children;return t.createElement(t.Fragment,{},r)}},m=t.forwardRef((function(e,r){var n=e.components,a=e.mdxType,s=e.originalType,l=e.parentName,i=o(e,["components","mdxType","originalType","parentName"]),d=c(n),m=a,k=d["".concat(l,".").concat(m)]||d[m]||p[m]||s;return n?t.createElement(k,u(u({ref:r},i),{},{components:n})):t.createElement(k,u({ref:r},i))}));function k(e,r){var n=arguments,a=r&&r.mdxType;if("string"==typeof e||a){var s=n.length,u=new Array(s);u[0]=m;var o={};for(var l in r)hasOwnProperty.call(r,l)&&(o[l]=r[l]);o.originalType=e,o[d]="string"==typeof e?e:a,u[1]=o;for(var c=2;c<s;c++)u[c]=n[c];return t.createElement.apply(null,u)}return t.createElement.apply(null,n)}m.displayName="MDXCreateElement"},90291:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>u,default:()=>p,frontMatter:()=>s,metadata:()=>o,toc:()=>c});var t=n(87462),a=(n(67294),n(3905));const s={sidebar_position:17},u="17. [BackEnd] db error handle",o={unversionedId:"backend-master/backend17",id:"backend-master/backend17",title:"17. [BackEnd] db error handle",description:"\ud559\uc2b5 \ubaa9\ud45c",source:"@site/docs/backend-master/backend17.md",sourceDirName:"backend-master",slug:"/backend-master/backend17",permalink:"/docs/backend-master/backend17",draft:!1,tags:[],version:"current",sidebarPosition:17,frontMatter:{sidebar_position:17},sidebar:"backSidebar",previous:{title:"16. [BackEnd] simplebank + user",permalink:"/docs/backend-master/backend16"},next:{title:"18. [BackEnd] password hash & implement request user api",permalink:"/docs/backend-master/backend18"}},l={},c=[{value:"\ud559\uc2b5 \ubaa9\ud45c",id:"\ud559\uc2b5-\ubaa9\ud45c",level:2},{value:"user sql \uc791\uc131",id:"user-sql-\uc791\uc131",level:2},{value:"\ud14c\uc2a4\ud2b8 \ucf54\ub4dc \uc791\uc131",id:"\ud14c\uc2a4\ud2b8-\ucf54\ub4dc-\uc791\uc131",level:2},{value:"\uc218\uc815",id:"\uc218\uc815",level:3},{value:"\uadf8\ub798\ub3c4 \uc5d0\ub7ec",id:"\uadf8\ub798\ub3c4-\uc5d0\ub7ec",level:3},{value:"\uc5d0\ub7ec \uba54\uc2dc\uc9c0 \ucee4\uc2a4\ud140",id:"\uc5d0\ub7ec-\uba54\uc2dc\uc9c0-\ucee4\uc2a4\ud140",level:2}],i={toc:c},d="wrapper";function p(e){let{components:r,...n}=e;return(0,a.kt)(d,(0,t.Z)({},i,n,{components:r,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"17-backend-db-error-handle"},"17. ","[BackEnd]"," db error handle"),(0,a.kt)("h2",{id:"\ud559\uc2b5-\ubaa9\ud45c"},"\ud559\uc2b5 \ubaa9\ud45c"),(0,a.kt)("hr",null),(0,a.kt)("p",null,"users \uc791\ub3d9\ud558\ub3c4\ub85d golang \ucd94\uac00 \ubc0f db error \uc870\uc791"),(0,a.kt)("h2",{id:"user-sql-\uc791\uc131"},"user sql \uc791\uc131"),(0,a.kt)("hr",null),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"-- name: CreateUser :one\nINSERT INTO users(\n    username,\n    hashed_password,\n    full_name,\n    email\n) VALUES (\n    $1, $2, $3, $4\n) RETURNING *;\n\n-- name: GetUser :one\nSELECT * FROM users\nWHERE username = $1 LIMIT 1;\n")),(0,a.kt)("p",null,"\uc791\uc131 \ud6c4 sqlc\ud558\uba74 \ub41c\ub2e4."),(0,a.kt)("h2",{id:"\ud14c\uc2a4\ud2b8-\ucf54\ub4dc-\uc791\uc131"},"\ud14c\uc2a4\ud2b8 \ucf54\ub4dc \uc791\uc131"),(0,a.kt)("hr",null),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'func createRandomUser(t *testing.T) User {\n    arg := CreateUserParams{\n        Username:       util.RandomOwner(),\n        HashedPassword: "secret", // bcrypt\uc0ac\uc6a9\ud558\uc5ec \ubcc0\uacbd\uc608\uc815\n        FullName:       util.RandomOwner(),\n        Email:          util.RandomEmail(),\n    }\n\n    user, err := testQueries.CreateUser(context.Background(), arg)\n    // is Error not nil?\n    require.NoError(t, err)\n\n    // is account empty?\n    require.NotEmpty(t, user)\n\n    // is value equal?\n    require.Equal(t, arg.Username, user.Username)\n    require.Equal(t, arg.HashedPassword, user.HashedPassword)\n    require.Equal(t, arg.FullName, user.FullName)\n    require.Equal(t, arg.Email, user.Email)\n\n    // is timestamp generate automatically?\n    require.True(t, user.PasswordLastChangedAt.IsZero())\n    require.NotZero(t, user.CreatedAt)\n\n    return user\n}\n\nfunc TestCreateUser(t *testing.T) {\n    createRandomUser(t)\n}\n\nfunc TestGetUser(t *testing.T) {\n    // create account\n    user1 := createRandomUser(t)\n    user2, err := testQueries.GetUser(context.Background(), user1.Username)\n\n    require.NoError(t, err)\n    require.NotEmpty(t, user2)\n\n    require.Equal(t, user1.Username, user2.Username)\n    require.Equal(t, user1.HashedPassword, user2.HashedPassword)\n    require.Equal(t, user1.FullName, user2.FullName)\n    require.Equal(t, user1.Email, user2.Email)\n\n    require.WithinDuration(t, user1.PasswordLastChangedAt, user2.PasswordLastChangedAt, time.Second)\n    require.WithinDuration(t, user1.CreatedAt, user2.CreatedAt, time.Second)\n}\n')),(0,a.kt)("p",null,"\uc774\uc804\uacfc \ub3d9\uc77c\ud558\uac8c \uc791\uc131\ud588\uc2b5\ub2c8\ub2e4."),(0,a.kt)("p",null,"user\uc5d0 \uad00\ud55c test code\ub294 \ud1b5\uacfc\ub418\uc9c0\ub9cc package test\ub294 \ud1b5\uacfc\ub418\uc9c0 \ubabb\ud569\ub2c8\ub2e4. \uc678\ub798\ud0a4 \uc81c\uc57d\uc870\uac74\uc744 \ub9cc\uc871\ud558\uc9c0 \ubabb\ud574\uc11c\uc778\ub370 \uc774\ub97c \uc218\uc815\ud574\ubcf4\uaca0\uc2b5\ub2c8\ub2e4."),(0,a.kt)("h3",{id:"\uc218\uc815"},"\uc218\uc815"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},"func createRandomAccount(t *testing.T) Account {\n    user := createRandomUser(t)\n    arg := CreateAccountParams{\n        Owner:    user.Username,\n        Balance:  util.RandomMoney(),\n        Currency: util.RandomCurrency(),\n    }\n    .\n    .\n    .\n}\n")),(0,a.kt)("p",null,"\uadf8\ub0e5 \uac04\ub2e8\ud558\uac8c createRandomAccount\uc5d0\uc11c owner \uac12\ub9cc \uc218\uc815\ud558\uba74 \ud574\uacb0\ub429\ub2c8\ub2e4."),(0,a.kt)("h3",{id:"\uadf8\ub798\ub3c4-\uc5d0\ub7ec"},"\uadf8\ub798\ub3c4 \uc5d0\ub7ec"),(0,a.kt)("p",null,"mock store\ub97c \uc0dd\uc131\ud55c \ubd80\ubd84 \ub54c\ubb38\uc5d0 \uc5d0\ub7ec\uac00 \ub09c\ub2e4\uace0 \ud569\ub2c8\ub2e4. \uc65c\ub0d0\ud558\uba74 \uc0c8\ub85c\uc6b4 \ud14c\uc774\ube14\uc744 \ucd94\uac00\ud588\uace0 \uc0c8\ub85c\uc6b4 \ucffc\ub9ac\ub97c \ucd94\uac00\ud588\ub294\ub370 mock store\uc5d4 \ubc18\uc601\uc774 \uc548\ub410\uc2b5\ub2c8\ub2e4."),(0,a.kt)("p",null,"make mock \ud558\uc5ec \ub2e4\uc2dc mock store\ub97c \uc0dd\uc131\ud569\ub2c8\ub2e4."),(0,a.kt)("p",null,"\uadf8\ub7ec\uba74 package test\ub3c4 \ud1b5\uacfc\ud569\ub2c8\ub2e4."),(0,a.kt)("h2",{id:"\uc5d0\ub7ec-\uba54\uc2dc\uc9c0-\ucee4\uc2a4\ud140"},"\uc5d0\ub7ec \uba54\uc2dc\uc9c0 \ucee4\uc2a4\ud140"),(0,a.kt)("hr",null),(0,a.kt)("p",null,"create account api\ub97c \uc694\uccad\ud560 \ub54c \uc5c6\ub294 \uc720\uc800 \uc774\ub984\uc744 owner\uc5d0 \ub123\uc73c\uba74 500\uc5d0\ub7ec\uac00 \ub0a9\ub2c8\ub2e4. \uc774\ub97c 403\uc73c\ub85c \uc218\uc815\ud574\uc57c\ud569\ub2c8\ub2e4."),(0,a.kt)("p",null,"\uc65c\ub0d0\ud558\uba74 \uc11c\ubc84 \uc5d0\ub7ec\uac00 \uc544\ub2cc \ud074\ub77c\uc774\uc5b8\ud2b8 \uc785\ub825\uac12 \uc5d0\ub7ec\uc774\uae30 \ub54c\ubb38"),(0,a.kt)("p",null,"\ucd94\uac00\ub85c \ub3d9\uc77c\ud55c owner \uc774\ub984\uc744 \uc0ac\uc6a9\uc2dc\uc5d0\ub3c4 500\uc5d0\ub7ec\uac00 \ub098\uc9c0\ub9cc 403\uc5d0\ub7ec\ub97c \ubc18\ud658\ud558\ub824 \ud569\ub2c8\ub2e4."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'    account, err := server.store.CreateAccount(ctx, arg)\n    if err != nil {\n        // \ucd94\uac00\ud55c \ucf54\ub4dc\n        if pqErr, ok := err.(*pq.Error); ok {\n            switch pqErr.Code.Name() {\n            case "foreign_key_violation", "unique_violation":\n                ctx.JSON(http.StatusForbidden, errorResponse(err))\n                return\n            }\n        }\n        ctx.JSON(http.StatusInternalServerError, errorResponse(err)) // \uc11c\ubc84 \uc5d0\ub7ec\n        return\n    }\n')),(0,a.kt)("p",null,"err\uc744 pq.Error\ub85c \ud615 \ubcc0\ud658 \ud6c4 switch case\ub85c \ud574\ub2f9 \uc5d0\ub7ec \uba54\uc2dc\uc9c0\uac00 \uc624\uba74 forbidden\uc744 \ubc18\ud658\ud558\ub3c4\ub85d \ud558\uba74 \ub41c\ub2e4."))}p.isMDXComponent=!0}}]);