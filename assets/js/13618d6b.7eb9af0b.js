"use strict";(self.webpackChunkblogsaurus=self.webpackChunkblogsaurus||[]).push([[53168],{3905:(n,e,t)=>{t.d(e,{Zo:()=>i,kt:()=>k});var c=t(67294);function r(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function a(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(n);e&&(c=c.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,c)}return t}function o(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?a(Object(t),!0).forEach((function(e){r(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function u(n,e){if(null==n)return{};var t,c,r=function(n,e){if(null==n)return{};var t,c,r={},a=Object.keys(n);for(c=0;c<a.length;c++)t=a[c],e.indexOf(t)>=0||(r[t]=n[t]);return r}(n,e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(n);for(c=0;c<a.length;c++)t=a[c],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(n,t)&&(r[t]=n[t])}return r}var l=c.createContext({}),d=function(n){var e=c.useContext(l),t=e;return n&&(t="function"==typeof n?n(e):o(o({},e),n)),t},i=function(n){var e=d(n.components);return c.createElement(l.Provider,{value:e},n.children)},s="mdxType",m={inlineCode:"code",wrapper:function(n){var e=n.children;return c.createElement(c.Fragment,{},e)}},p=c.forwardRef((function(n,e){var t=n.components,r=n.mdxType,a=n.originalType,l=n.parentName,i=u(n,["components","mdxType","originalType","parentName"]),s=d(t),p=r,k=s["".concat(l,".").concat(p)]||s[p]||m[p]||a;return t?c.createElement(k,o(o({ref:e},i),{},{components:t})):c.createElement(k,o({ref:e},i))}));function k(n,e){var t=arguments,r=e&&e.mdxType;if("string"==typeof n||r){var a=t.length,o=new Array(a);o[0]=p;var u={};for(var l in e)hasOwnProperty.call(e,l)&&(u[l]=e[l]);u.originalType=n,u[s]="string"==typeof n?n:r,o[1]=u;for(var d=2;d<a;d++)o[d]=t[d];return c.createElement.apply(null,o)}return c.createElement.apply(null,t)}p.displayName="MDXCreateElement"},41186:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>l,contentTitle:()=>o,default:()=>m,frontMatter:()=>a,metadata:()=>u,toc:()=>d});var c=t(87462),r=(t(67294),t(3905));const a={sidebar_position:9},o="09. [BackEnd] avoid db deadlock",u={unversionedId:"backend-master/backend9",id:"backend-master/backend9",title:"09. [BackEnd] avoid db deadlock",description:"\ucd94\uac00\uc801\uc778 deadlock \uc0c1\ud669",source:"@site/docs/backend-master/backend9.md",sourceDirName:"backend-master",slug:"/backend-master/backend9",permalink:"/docs/backend-master/backend9",draft:!1,tags:[],version:"current",sidebarPosition:9,frontMatter:{sidebar_position:9},sidebar:"backSidebar",previous:{title:"08. [BackEnd] golang db transaction deadlock",permalink:"/docs/backend-master/backend8"},next:{title:"10. [BackEnd] transaction isolation level",permalink:"/docs/backend-master/backend10"}},l={},d=[{value:"\ucd94\uac00\uc801\uc778 deadlock \uc0c1\ud669",id:"\ucd94\uac00\uc801\uc778-deadlock-\uc0c1\ud669",level:2},{value:"deadlock\uc774 \ub09c \uc774\uc720",id:"deadlock\uc774-\ub09c-\uc774\uc720",level:2},{value:"deadlock \ud574\uacb0\ubc29\uc548",id:"deadlock-\ud574\uacb0\ubc29\uc548",level:2},{value:"\ucf54\ub4dc \uc218\uc815",id:"\ucf54\ub4dc-\uc218\uc815",level:3},{value:"\ub9ac\ud329\ud1a0\ub9c1",id:"\ub9ac\ud329\ud1a0\ub9c1",level:3}],i={toc:d},s="wrapper";function m(n){let{components:e,...t}=n;return(0,r.kt)(s,(0,c.Z)({},i,t,{components:e,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"09-backend-avoid-db-deadlock"},"09. ","[BackEnd]"," avoid db deadlock"),(0,r.kt)("h2",{id:"\ucd94\uac00\uc801\uc778-deadlock-\uc0c1\ud669"},"\ucd94\uac00\uc801\uc778 deadlock \uc0c1\ud669"),(0,r.kt)("hr",null),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"-- TX1 : transfer $10 from account 1 to account2\nBEGIN;\n\nUPDATE accounts SET balance = balance - 10 WHERE id=1 RETURNING *;\nUPDATE accounts set balance = balance + 10 WHERE id=2 RETURNING *; \n\nROLLBACK;\n\n-- TX2 : transfer $10 from account 2 to account1\n\nBEGIN;\n\nUPDATE accounts SET balance = balance - 10 WHERE id=2 RETURNING *;\nUPDATE accounts set balance = balance + 10 WHERE id=1 RETURNING *; \n\nROLLBACK;\n")),(0,r.kt)("p",null,"\uc774\ub807\uac8c \uc704\ucc98\ub7fc 1 > 2, 2 > 1 \ud1b5\uc2e0\uc744 \ud558\uba74 deadlock\uc774 \uac78\ub9bc"),(0,r.kt)("p",null,"\uc65c\ub0d0\ud558\uba74 \uc11c\ub85c \ub458 \ub2e4 \ub2e4\ub978 \ud2b8\ub79c\uc7ad\uc158\uc744 \uae30\ub2e4\ub9ac\uae30 \ub54c\ubb38\uc785\ub2c8\ub2e4."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'\nfunc TestTransferTxDeadlock(t *testing.T) {\n    store := NewStore(testDB)\n\n    account1 := createRandomAccount(t)\n    account2 := createRandomAccount(t)\n    fmt.Println("[LOG] before balance (account1) : ", account1.Balance)\n    fmt.Println("[LOG] before balance (account2) : ", account2.Balance)\n\n    // \ub3d9\uc2dc\uc131 \ud14c\uc2a4\ud2b8\ub97c \uc704\ud574 go routine\uc744 \ud65c\uc6a9\n    n := 10\n    amount := int64(10)\n\n    errs := make(chan error)\n    results := make(chan TransferTxResult)\n\n    for i := 0; i < n; i++ {\n        fromAccountID := account1.ID\n        toAccountID := account2.ID\n\n        if i%2 == 1 {\n            fromAccountID = account2.ID\n            toAccountID = account1.ID\n        }\n\n        go func() {\n\n            result, err := store.TransferTx(context.Background(), TransferTxParams{\n                FromAccountID: fromAccountID,\n                ToAccountID:   toAccountID,\n                Amount:        amount,\n            })\n            errs <- err\n            results <- result\n        }()\n    }\n\n    for i := 0; i < n; i++ {\n        err := <-errs\n        require.NoError(t, err)\n    }\n\n    updatedAccount1, err := testQueries.GetAccount(context.Background(), account1.ID)\n    require.NoError(t, err)\n\n    updatedAccount2, err := testQueries.GetAccount(context.Background(), account2.ID)\n    require.NoError(t, err)\n\n    fmt.Println("[LOG] update balance (account1) : ", updatedAccount1.Balance)\n    fmt.Println("[LOG] update balance (account2) : ", updatedAccount2.Balance)\n\n    require.Equal(t, account1.Balance, updatedAccount1.Balance)\n    require.Equal(t, account2.Balance, updatedAccount2.Balance)\n}\n')),(0,r.kt)("p",null,"\uadf8\ub798\uc11c \uc704\uc758 \ud14c\uc2a4\ud2b8 \ucf54\ub4dc\ub97c \uc2e4\ud589 \uc2dc deadlock \uc5d0\ub7ec\uac00 \ub098\ub294 \uac83\uc744 \uc54c \uc218 \uc788\uc2b5\ub2c8\ub2e4."),(0,r.kt)("p",null,"\uc704\uc758 \ud14c\uc2a4\ud2b8 \ucf54\ub4dc\ub294 5\uac1c\ub294 1 > 2\ub85c \uc1a1\uae08 5\uac1c\ub294 2 > 1\ub85c \uc1a1\uae08\ud558\ub294 \ud14c\uc2a4\ud2b8\uc785\ub2c8\ub2e4."),(0,r.kt)("h2",{id:"deadlock\uc774-\ub09c-\uc774\uc720"},"deadlock\uc774 \ub09c \uc774\uc720"),(0,r.kt)("hr",null),(0,r.kt)("p",null,"\uc704\uc758 sql\uc744 \ubcf4\uc2dc\uba74 ",(0,r.kt)("inlineCode",{parentName:"p"},"TX1"),"\uc740 account1\uc744 \uba3c\uc800 \uc5c5\ub370\uc774\ud2b8 \ud558\uace0 account2\ub97c \uc5c5\ub370\uc774\ud2b8\ud558\ub294\ub370 ",(0,r.kt)("inlineCode",{parentName:"p"},"TX2"),"\ub294 account2\ub97c \uc5c5\ub370\uc774\ud2b8\ud558\uace0 account1\uc744 \uc5c5\ub370\uc774\ud2b8\ud569\ub2c8\ub2e4."),(0,r.kt)("p",null,"\uc5c5\ub370\uc774\ud2b8 \uc21c\uc11c\uac00 \ub2e4\ub974\uae30\uc5d0 deadlock\uc774 \ub098\ub294 \uac83\uc774\ub77c \uc5c5\ub370\uc774\ud2b8 \uc21c\uc11c(\uc5c5\ub370\uc774\ud2b8 \ud558\ub294 \uacc4\uc815 \uc21c\uc11c)\ub97c \uac19\uac8c \ud574\uc90d\ub2c8\ub2e4."),(0,r.kt)("h2",{id:"deadlock-\ud574\uacb0\ubc29\uc548"},"deadlock \ud574\uacb0\ubc29\uc548"),(0,r.kt)("hr",null),(0,r.kt)("p",null,"\uc5b8\uc81c\ub098 \uc5c5\ub370\uc774\ud2b8\uc758 \uc21c\uc11c\ub97c \uc77c\uad00\ub418\uac8c \uc124\uc815\ud574\ub193\uc73c\uba74 \ud574\uacb0\ud560 \uc218 \uc788\ub2e4."),(0,r.kt)("h3",{id:"\ucf54\ub4dc-\uc218\uc815"},"\ucf54\ub4dc \uc218\uc815"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"    if arg.FromAccountID < arg.ToAccountID {\n            // fromAccount\n            result.FromAccount, err = q.AddAccountBalance(ctx, AddAccountBalanceParams{\n                ID:     arg.FromAccountID,\n                Amount: -arg.Amount,\n            })\n            if err != nil {\n                return err\n            }\n\n            // toAccount\n            result.ToAccount, err = q.AddAccountBalance(ctx, AddAccountBalanceParams{\n                ID:     arg.ToAccountID,\n                Amount: arg.Amount,\n            })\n            if err != nil {\n                return err\n            }\n        } else {\n            // toAccount\n            result.ToAccount, err = q.AddAccountBalance(ctx, AddAccountBalanceParams{\n                ID:     arg.ToAccountID,\n                Amount: arg.Amount,\n            })\n            if err != nil {\n                return err\n            }\n            // fromAccount\n            result.FromAccount, err = q.AddAccountBalance(ctx, AddAccountBalanceParams{\n                ID:     arg.FromAccountID,\n                Amount: -arg.Amount,\n            })\n            if err != nil {\n                return err\n            }\n        }\n")),(0,r.kt)("p",null,"account update\ud558\ub294 \ubd80\ubd84\uc5d0 id\ub97c \uac80\uc0ac\ud558\ub294 \ub85c\uc9c1\uc744 \ucd94\uac00\ud558\uc5ec \uc5c5\ub370\uc774\ud2b8\ud558\ub294 \uacc4\uc815 \uc21c\uc11c\ub97c \ub9de\ucdb0\uc8fc\uba74 \ud574\uacb0\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."),(0,r.kt)("h3",{id:"\ub9ac\ud329\ud1a0\ub9c1"},"\ub9ac\ud329\ud1a0\ub9c1"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"func addMoney(\n    ctx context.Context,\n    q *Queries,\n    accountID1 int64,\n    amount1 int64,\n    accountID2 int64,\n    amount2 int64,\n) (account1 Account, account2 Account, err error) {\n    account1, err = q.AddAccountBalance(ctx, AddAccountBalanceParams{\n        ID:     accountID1,\n        Amount: amount1,\n    })\n    if err != nil {\n        // return\uc5d0 \uc544\ubb34\uac83\ub3c4 \uc548\uc801\uc5b4\ub3c4 return account1, account2, err\uac00 \ubc18\ud658\ub428\n        // \uc65c\ub0d0\ud558\uba74 return \ubcc0\uc218\uba85\uc744 \uc815\ud574\uc918\uc11c\n        return\n    }\n    account2, err = q.AddAccountBalance(ctx, AddAccountBalanceParams{\n        ID:     accountID2,\n        Amount: amount2,\n    })\n    return\n}\n")),(0,r.kt)("p",null,"\uc704 \ud568\uc218\ub97c \ud1b5\ud574\uc11c \ub9ac\ud329\ud1a0\ub9c1\ud560 \uc218 \uc788\ub2e4."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"        if arg.FromAccountID < arg.ToAccountID {\n            result.FromAccount, result.ToAccount, err = addMoney(ctx, q, arg.FromAccountID, -arg.Amount, arg.ToAccountID, arg.Amount)\n        } else {\n            result.FromAccount, result.ToAccount, err = addMoney(ctx, q, arg.ToAccountID, arg.Amount, arg.FromAccountID, -arg.Amount)\n        }\n")),(0,r.kt)("p",null,"\uae38\uc5c8\ub358 \ucf54\ub4dc\uac00 \uc774\ub807\uac8c \uc9e7\uac8c \ubcc0\ud588\ub2e4."))}m.isMDXComponent=!0}}]);