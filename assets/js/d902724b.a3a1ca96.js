"use strict";(self.webpackChunkblogsaurus=self.webpackChunkblogsaurus||[]).push([[47095],{3905:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>m});var a=t(67294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function c(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?c(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):c(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function r(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},c=Object.keys(e);for(a=0;a<c.length;a++)t=c[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(a=0;a<c.length;a++)t=c[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var i=a.createContext({}),d=function(e){var n=a.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},u=function(e){var n=d(e.components);return a.createElement(i.Provider,{value:n},e.children)},p="mdxType",k={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},s=a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,c=e.originalType,i=e.parentName,u=r(e,["components","mdxType","originalType","parentName"]),p=d(t),s=o,m=p["".concat(i,".").concat(s)]||p[s]||k[s]||c;return t?a.createElement(m,l(l({ref:n},u),{},{components:t})):a.createElement(m,l({ref:n},u))}));function m(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var c=t.length,l=new Array(c);l[0]=s;var r={};for(var i in n)hasOwnProperty.call(n,i)&&(r[i]=n[i]);r.originalType=e,r[p]="string"==typeof e?e:o,l[1]=r;for(var d=2;d<c;d++)l[d]=t[d];return a.createElement.apply(null,l)}return a.createElement.apply(null,t)}s.displayName="MDXCreateElement"},98144:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>l,default:()=>k,frontMatter:()=>c,metadata:()=>r,toc:()=>d});var a=t(87462),o=(t(67294),t(3905));const c={sidebar_position:8},l="08. [BackEnd] golang db transaction deadlock",r={unversionedId:"backend-master/backend8",id:"backend-master/backend8",title:"08. [BackEnd] golang db transaction deadlock",description:"TDD",source:"@site/docs/backend-master/backend8.md",sourceDirName:"backend-master",slug:"/backend-master/backend8",permalink:"/docs/backend-master/backend8",draft:!1,tags:[],version:"current",sidebarPosition:8,frontMatter:{sidebar_position:8},sidebar:"backSidebar",previous:{title:"07. [BackEnd] golang transaction \uad6c\ud604",permalink:"/docs/backend-master/backend7"},next:{title:"09. [BackEnd] avoid db deadlock",permalink:"/docs/backend-master/backend9"}},i={},d=[{value:"TDD",id:"tdd",level:2},{value:"account \ud14c\uc2a4\ud2b8 \ucf54\ub4dc \uc791\uc131",id:"account-\ud14c\uc2a4\ud2b8-\ucf54\ub4dc-\uc791\uc131",level:2},{value:"deadlock \ud574\uacb0",id:"deadlock-\ud574\uacb0",level:2},{value:"For Update \ucffc\ub9ac",id:"for-update-\ucffc\ub9ac",level:3},{value:"deadlock \ub514\ubc84\uae45",id:"deadlock-\ub514\ubc84\uae45",level:2},{value:"\ud574\uacb0\ubc95",id:"\ud574\uacb0\ubc95",level:3},{value:"\uacc4\uc815 \uc794\uc561 \ubcc0\uacbd sql \uac1c\uc120",id:"\uacc4\uc815-\uc794\uc561-\ubcc0\uacbd-sql-\uac1c\uc120",level:2}],u={toc:d},p="wrapper";function k(e){let{components:n,...t}=e;return(0,o.kt)(p,(0,a.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"08-backend-golang-db-transaction-deadlock"},"08. ","[BackEnd]"," golang db transaction deadlock"),(0,o.kt)("h2",{id:"tdd"},"TDD"),(0,o.kt)("hr",null),(0,o.kt)("p",null,"TDD\ub294 Test Driven Development\ub85c \ud14c\uc2a4\ud2b8\ub97c \uba3c\uc800\ud558\uace0 \uadf8 \ub2e4\uc74c\uc5d0 \ud14c\uc2a4\ud2b8\uac00 \ud1b5\uacfc\ub418\uba74 \ucf54\ub4dc\ub97c \uac1c\uc120\ud558\ub294 \ubc29\uc2dd\uc785\ub2c8\ub2e4."),(0,o.kt)("h2",{id:"account-\ud14c\uc2a4\ud2b8-\ucf54\ub4dc-\uc791\uc131"},"account \ud14c\uc2a4\ud2b8 \ucf54\ub4dc \uc791\uc131"),(0,o.kt)("hr",null),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},"    existed := make(map[int]bool)\n    {\n        .\n        .\n        .\n        \n        fromAccount := result.FromAccount\n        require.NotEmpty(t, fromAccount)\n        require.Equal(t, account1.ID, fromAccount.ID)\n\n        toAccount := result.ToAccount\n        require.NotEmpty(t, toAccount)\n        require.Equal(t, account2.ID, toAccount.ID)\n\n        // check different balance\n\n        diff1 := account1.Balance - fromAccount.Balance\n        diff2 := toAccount.Balance - account2.Balance\n        require.Equal(t, diff1, diff2)\n        require.True(t, diff1 > 0)\n        require.True(t, diff1%amount == 0)\n\n        k := int(diff1 / amount)\n        require.True(t, k >= 1 && k <= n)\n        require.NotContains(t, existed, k)\n        existed[k] = true\n    }\n\n    updatedAccount1, err := testQueries.GetAccount(context.Background(), account1.ID)\n    require.NoError(t, err)\n\n    updatedAccount2, err := testQueries.GetAccount(context.Background(), account2.ID)\n    require.NoError(t, err)\n\n    require.Equal(t, account1.Balance-int64(n)*amount, updatedAccount1.Balance)\n    require.Equal(t, account2.Balance+int64(n)*amount, updatedAccount2.Balance)\n")),(0,o.kt)("h2",{id:"deadlock-\ud574\uacb0"},"deadlock \ud574\uacb0"),(0,o.kt)("hr",null),(0,o.kt)("p",null,"\uc9c0\ub09c \uac8c\uc2dc\uae00\uc5d0\uc11c \ub9cc\ub4e4\uc5b4\ubcf8 fromAccount\uc640 toAccount\uac00 \uc798\ubabb\ub410\ub2e4. \uc65c\ub0d0\ud558\uba74 \ub3d9\uc2dc\uc5d0 transaction begin\uc744 \ud558\uac8c \ub418\uba74 \ub3d9\uc2dc\uc5d0 \uac19\uc740 \uacc4\uc815\uc744 \uac00\ub9ac\ud0a4\uae30 \ub54c\ubb38\uc5d0 \uc5c5\ub370\uc774\ud2b8\uac00 \uc81c\ub300\ub85c \ub418\uc9c0 \uc54a\ub294\ub2e4."),(0,o.kt)("p",null,"\uc774\ub97c \ud574\uacb0\ud558\uae30 \uc704\ud574 ",(0,o.kt)("inlineCode",{parentName:"p"},"For Update"),"\ub97c \uc0ac\uc6a9\ud574\uc918\uc57c \ud55c\ub2e4."),(0,o.kt)("h3",{id:"for-update-\ucffc\ub9ac"},"For Update \ucffc\ub9ac"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT * FROM accounts\nWHERE id = $1 LIMIT 1\nFOR UPDATE;\n")),(0,o.kt)("p",null,"FOR UPDATE\ub9cc \ub123\uc5b4\uc8fc\uace0 \ub2e4\uc2dc sqlc\ud574\uc900\ub2e4."),(0,o.kt)("p",null,"\ud558\uc9c0\ub9cc \uc774\ub807\uac8c \ud574\ub3c4 \uad50\ucc29\uc0c1\ud0dc\uc5d0 \ube60\uc9d1\ub2c8\ub2e4."),(0,o.kt)("h2",{id:"deadlock-\ub514\ubc84\uae45"},"deadlock \ub514\ubc84\uae45"),(0,o.kt)("hr",null),(0,o.kt)("p",null,"\ub514\ubc84\uae45\ud558\uae30 \uc704\ud574\uc11c context\uc5d0 transaction \uc774\ub984\uc744 \ub123\uc5b4\uc57c \ud569\ub2c8\ub2e4."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},"var txKey = struct{}{}\n")),(0,o.kt)("p",null,"txKey\ub77c\ub294 \uad6c\uc870\uccb4\ub97c \ub9cc\ub4ed\ub2c8\ub2e4. ",(0,o.kt)("inlineCode",{parentName:"p"},"struct{}{}")," \uc774\ub807\uac8c \ud558\ub294 \uac83\uc740 \ube48 \uad6c\uc870\uccb4\ub97c \ub9cc\ub4e0\ub2e4\ub294 \ub73b\uc785\ub2c8\ub2e4."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'txName := fmt.Sprintf("tx %d", i+1)\nctx := context.WithValue(context.Background(), txKey, txName)\n')),(0,o.kt)("p",null,"\uc704\uc640 \uac19\uc740 \ubc29\uc2dd\uc73c\ub85c context\ub97c \ub9cc\ub4e4\uba74 context\uc5d0 txName\uc774 \ud3ec\ud568\ub429\ub2c8\ub2e4."),(0,o.kt)("p",null,"txName\uc740 ",(0,o.kt)("inlineCode",{parentName:"p"},"context.Value(txKey)")," \ud568\uc218\ub97c \ud1b5\ud574\uc11c \uc5bb\uc744 \uc218 \uc788\uc2b5\ub2c8\ub2e4."),(0,o.kt)("p",null,"\ud14c\uc2a4\ud2b8\ub97c \uc2e4\ud589\ud574\ubcf4\uace0 \ub098\uc628 \uacb0\uacfc\ub97c \uc2e4\uc81c sql\ub85c \ub530\ub77c\ud574\ubcf8\ub2e4."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"BEGIN;\n\nINSERT INTO transfers (from_accounts_id, to_accounts_id, amount) VALUES (1,2,10) RETURNING *;\n\nINSERT INTO entries (accounts_id, amount) VALUES (1,-10) RETURNING *;\nINSERT INTO entries (accounts_id, amount) VALUES (1,10) RETURNING *;\n\nSELECT * FROM accounts WHERE id=1 FOR UPDATE\nUPDATE accounts SET balance = 190 WHERE id=1 RETURNING;\n\nSELECT * FROM accounts WHERE id=2 FOR UPDATE\nUPDATE accounts SET balance = 210 WHERE id=1 RETURNING;\n\nROLLBACK;\n")),(0,o.kt)("p",null,"\ud558\ub2e4\ubcf4\uba74 get account\uac00 \uc548\ub418\ub294 \uac83\uc744 \uc54c \uc218 \uc788\ub2e4."),(0,o.kt)("p",null,"\ub354 \uc790\uc138\ud788 \ubcf4\ub824\uba74 \uc544\ub798 sql\uc744 \uc785\ub825\ud558\uba74 \ub41c\ub2e4."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"  SELECT blocked_locks.pid     AS blocked_pid,\n         blocked_activity.usename  AS blocked_user,\n         blocking_locks.pid     AS blocking_pid,\n         blocking_activity.usename AS blocking_user,\n         blocked_activity.query    AS blocked_statement,\n         blocking_activity.query   AS current_statement_in_blocking_process\n   FROM  pg_catalog.pg_locks         blocked_locks\n    JOIN pg_catalog.pg_stat_activity blocked_activity  ON blocked_activity.pid = blocked_locks.pid\n    JOIN pg_catalog.pg_locks         blocking_locks \n        ON blocking_locks.locktype = blocked_locks.locktype\n        AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database\n        AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation\n        AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page\n        AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple\n        AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid\n        AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid\n        AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid\n        AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid\n        AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid\n        AND blocking_locks.pid != blocked_locks.pid\n\n    JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid\n   WHERE NOT blocked_locks.granted;\n")),(0,o.kt)("p",null,"\uc544\ub798 sql\ub3c4 \uac19\uc740 \uc5ed\ud560\uc744 \ud569\ub2c8\ub2e4."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},'SELECT a.datname,\n         a.application_name\n         l.relation::regclass,\n         l.transactionid,\n         l.mode,\n         l.GRANTED,\n         a.usename,\n         a.query,\n         a.query_start,\n         age(now(), a.query_start) AS "age",\n         a.pid\nFROM pg_stat_activity a\nJOIN pg_locks l ON l.pid = a.pid\nORDER BY a.query_start;\n')),(0,o.kt)("admonition",{title:"\uc18d\uc131 \uc758\ubbf8",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("inlineCode",{parentName:"p"},"a.application_name")," : \uc7a0\uae08\uc774 \ubc1c\uc0dd\ud55c \uc5b4\ud50c\ub9ac\ucf00\uc774\uc158"),(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("inlineCode",{parentName:"p"},"l.relation::regclass")," : \ud14c\uc774\ube14 \uc774\ub984"),(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("inlineCode",{parentName:"p"},"l.transactionid")," : \ud2b8\ub79c\uc81d\uc158 \uc544\uc774\ub514"),(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("inlineCode",{parentName:"p"},"l.mode")," : \uc7a0\uae08 \ubaa8\ub4dc"),(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("inlineCode",{parentName:"p"},"l.locktype"),": \uc7a0\uae08 \uc720\ud615"),(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("inlineCode",{parentName:"p"},"l.GRANTED")," : \uc7a0\uae08 \ubd80\uc5ec \uc5ec\ubd80"),(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("inlineCode",{parentName:"p"},"a.usename")," : \ucffc\ub9ac \uc2e4\ud589 \uc0ac\uc6a9\uc790 \uc774\ub984"),(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("inlineCode",{parentName:"p"},"a.query")," : \uc7a0\uae08 \ubcf4\uc720\ud558\uac70\ub098 \ud68d\ub4dd\ud558\ub824\ub294 \ucffc\ub9ac"),(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("inlineCode",{parentName:"p"},"a.pid")," : pid")),(0,o.kt)("p",null,"\uc774\ub807\uac8c \ud574\uc11c \uc54c\uc544\ub0b8 \uac83\uc774 \ud0a4 \uc81c\uc57d\uc870\uac74\uc73c\ub85c \uc778\ud574\uc11c \uad50\ucc29 \uc0c1\ud0dc\uac00 \ubc1c\uc0dd\ud55c\ub2e4\ub294 \uac83\uc785\ub2c8\ub2e4."),(0,o.kt)("p",null,"\uac00\uc7a5 \uac04\ub2e8\ud55c \ubc29\ubc95\uc740 \ud0a4 \uc81c\uc57d\uc870\uac74\uc744 \uc81c\uac70\ud558\ub294 \uac83\uc785\ub2c8\ub2e4. \ud558\uc9c0\ub9cc \uc774\ub294 \uc88b\uc740 \ubc29\ubc95\uc774 \uc544\ub2cc \uac83\uc774 \uc77c\uad00\uc131 \uc720\uc9c0\ub97c \ud574\uc57c\ud558\uae30 \ub54c\ubb38\uc785\ub2c8\ub2e4."),(0,o.kt)("h3",{id:"\ud574\uacb0\ubc95"},"\ud574\uacb0\ubc95"),(0,o.kt)("p",null,"account \uc5c5\ub370\uc774\ud2b8\ub97c \ud560 \ub54c account_id\ub97c \ubcc0\uacbd\ud558\ub294 \uac83\uc774 \uc544\ub2c8\uae30 \ub54c\ubb38\uc5d0"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"FOR UPDATE")," \ub300\uc2e0\uc5d0 ",(0,o.kt)("inlineCode",{parentName:"p"},"FOR NO KEY UPDATE"),"\ub97c \uc0ac\uc6a9\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT * FROM accounts\nWHERE id = $1 LIMIT 1\nFOR NO KEY UPDATE;\n")),(0,o.kt)("h2",{id:"\uacc4\uc815-\uc794\uc561-\ubcc0\uacbd-sql-\uac1c\uc120"},"\uacc4\uc815 \uc794\uc561 \ubcc0\uacbd sql \uac1c\uc120"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"-- name: AddAccountBalance :one\nUPDATE accounts \nSET balance = balance + sqlc.arg(amount)\nWHERE id = sqlc.arg(id)\nRETURNING *;\n")),(0,o.kt)("p",null,"\uc704\ucc98\ub7fc \uac1c\uc120\ud574\uc11c \uc9c4\ud589\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"sqlc.arg(\ubcc0\uc218\uba85)")," \uc73c\ub85c \uc124\uc815\ud558\uace0 ",(0,o.kt)("inlineCode",{parentName:"p"},"sqlc generate"),"\ud558\uba74 \ud574\ub2f9 \ubcc0\uc218\uba85\uc73c\ub85c parameter\uac00 \uc0dd\uae41\ub2c8\ub2e4."))}k.isMDXComponent=!0}}]);